# Gem5-ex3 - McPAT

# 1ο Βήμα - Εξοικείωση με τον εξομοιωτή McPAT

Το McPAT αποτελεί έναν εξομοιωτή ισχύος, χώρου, και χρονισμού συμβατό και με πολυνηματικές και πολυπύρηνες αρχιτεκτονικές. Περιλαμβάνει τα μοντέλα επεξεργαστών, το δίκτυο επικοινωνίας, την κοινόχρηστη κρυφή μνήμη Cache και τους ελεγκτές μνήμης για να μπορέσει να εξάγει συμπεράσματα για τον χρονισμό, την έκταση του επεξεργαστή, την απαιτούμενη ισχύ για διάφορες τεχνολογίες από 90nm μέχρι 20nm.

- Πηγή [HP - McPAT](https://www.hpl.hp.com/research/mcpat/)

Clone github McPat

``` git clone https://github.com/kingmouf/cmcpat.git my_mcpat ```

*Πιθανόν χρειάζονται τα παρακάτω πακέτα*
- ```sudo apt install libc6-dev-i386``` για 32bit.
  ή ```sudo apt-get install g++-multilib``` για 64bit
- ```sudo apt install gcc-7-multilib g++-7-multilib```

Compile with make

- ```cd my_mcpat/mcpat```
- ```make```

Εκτέλεση του McPAT για τον επεξεργαστή *Xeon* από το φάκελο ProcessorDescriptionFiles
- ```./mcpat -infile ProcessorDescriptionFiles/Xeon.xml -print_level 1```
*-print_level 1,2,3,4,5*

## Ερώτημα 1ο

### Αποτελέσματα της προσομοίωσης με τον McPAT [Xeon - McPAT](/src/McPAT_output/Xeon.txt)

- Τεχνολογία Τρανζίστορ : [65nm](/src/McPAT/Xeon.txt#L6)

**Κατανάλωση Ισχύος Επεξεργαστή**
- Peak Power            : [134.938 W](/src/McPAT_output/Xeon.txt#L14)
- Total Leakage         : [36.8319 W](/src/McPAT_output/Xeon.txt#L15)
  - Subthreshold Leakage  : [35.1632 W](/src/McPAT_output/Xeon.txt#L17)
  - Gate Leakage          : [1.66871 W](/src/McPAT_output/Xeon.txt#L19)
- Peak Dynamic          : [98.1063 W](/src/McPAT_output/Xeon.txt#L16)
  - Runtime Dynamic     : [72.9199 W](/src/McPAT_output/Xeon.txt#L20)

### Επεξήγηση των όρων Dynamic Power και Leakage Power

Η Κατανάλωση Ισχύος σε ένα ολοκληρωμένο κύκλωμα χωρίζεται σε 2 κατηγορίες. Την στατική κατανάλωση ισχύος (Static Power dissipation ή Power Leakage) και την δυναμική κατανάλωση ισχύος (Dynamic power dissipation). Την ενέργεια αυτή την καταναλώνει κάθε διακόπτης για να αλλάξει ή για να διατηρήσει την κατάσταση που βρίσκεται (on ή off).

Η **Στατική κατανάλωση ισχύος** ή **Leakage Power** αναφέρεται στην μέση ισχύ που απαιτεί ένας διακόπτης/τρανζίστορ για να βρίσκεται σε λειτουργία. Θεωρητικά εντοπίζεται ροή ρεύματος μόνο μεταξύ της πηγής και του εκπομπού του τρανζίστορ. Όμως στην πράξη, υπάρχουν μικρά ρεύματα από την πύλη (Gate leakage) και από το υπόστρωμα (Subthreshold leakage) που καταναλώνουν ενέργεια *ανάλογη της τάσης τροφοδοσίας, της τάσης κατωφλίου και του λόγου W/L* δηλαδή των μεγεθών του τρανζίστορ. Η ενέργεια αυτή καταναλώνεται ακόμα και στην αλλαγή της κατάστασης του διακόπτη και για αυτό ονομάζεται Στατική.  

Η **Δυναμική Κατανάλωση** ισχύος είναι η μέση ενέργεια ανά μονάδα χρόνου που χρειάζεται κατά την αλλαγή της κατάστασης του ο αντιστροφέας και οφείλεται στην ύπαρξη ροής ρεύματος διαμέσου του διακόπτη για την φόρτιση και την εκφόρτιση του χωρητικού φορτίου αλλά και εξαιτίας των ρευμάτων βραχυκύκλωσης που δημιουργούνται στο εσωτερικό των τρανζίστορ του διακόπτη. Αυτά τα ρεύματα αναγκάζουν τους διακόπτες να καταναλώνουν ενέργεια που η οποία ανά μονάδα χρόνου ονομάζεται Δυναμική κατανάλωση Ισχύος. Αυτή η ισχύς αυξάνεται με την αύξηση της συχνότητας του ρολογιού, την τάση τροφοδοσίας και της χωρητικότητας του τρανζίστορ σύμφωνα με την εξίσωση ``` P=f*C*V^2``` ανά κύκλο. Η νέες τεχνολογίες μικραίνουν την τάση τροφοδοσίας αλλά οι απαιτήσεις για μεγάλη συχνότητα μπορούν να αυξήσουν την ισχύ αυτή σημαντικά.

- Πηγές
  - *Sedra, A.S. & Smith, K.C. (1982) Mircoelectronic Circuits, Seven Edition, p.1149*
  - *[McPAT Research](https://www.hpl.hp.com/research/mcpat/micro09.pdf)*
  - *[Semiconductor Engineering](https://semiengineering.com/knowledge_centers/low-power/low-power-design/power-consumption/)*

### Πως ένα πρόγραμμα επηρεάζει την Κατανάλωση Ισχύος

Η Δυναμική Κατανάλωση Ισχύος (Dynamic Power) και η Στατική Κατανάλωση Ισχύος (Leakage Power) επηρεάζονται διαφορετικά από την συμπεριφορά του συστήματος. Η Στατική Ισχύς απαιτείται είτε το σύστημα βρίσκεται σε χρήση είτε σε αναμονή. Αντίθετα το Dynamic Power απαιτείται μόνο κατά την χρήση των κυκλωμάτων στο σύστημα ενώ σε κατάσταση αναμονής δεν απαιτείται Δυναμική Ισχύς.

Επομένος ένα πρόγραμμα επηρεάζει μόνο το Dynamic Power του συστήματος. Η κατανάλωση αυτή μπορεί να μειωθεί με την χρήση εντολών που απαιτούν μικρότερο αριθμό κύκλων και κατά επέκταση μικρότερη συχνότητα λειτουργίας ή με την παράλληλοποίηση του προγράμματος σε πολυπύρηνα συστήματα. Επιπλέον σημαντικός παράγοντας κατανάλωσης ενέργειας είναι οι προσπελάσεις στην μνήμη ενός προγράμματος. Σε κάθε αναζήτηση ενεργοποιούνται οι διακόπτες των κυκλωμάτων της μνήμης με αποτέλεσμα να έχουμε μεγάλη κατανάλωση ενέργειας και αύξηση του Dynamic Power.

Η χρονική διάρκεια του προγράμματος, δεδομένου ότι το σύστημα εκτελεί μόνο τη συγκεκριμένη εφαρμογή και τερματίζει επηρεάζει το Leakage Power. Σε όλη την διάρκεια που το σύστημα είναι ενεργοποιημένο, ανεξάρτητα από το ποσοστό χρήσης του, καταναλώνει ενέργεια με αποτέλεσμα τα προγράμματα με μεγαλύτερη διάρκεια να αυξάνουν την μέση Στατική κατανάλωση ενέργειας (Leakage Power).


## Ερώτημα 2ο

### Energy Efficiency - Ενεργειακή Αποδοτικότητα

Η **Ενεργειακή Αποδοτικότητα** είναι η διεκπεραιωτική ικανότητα μιας αρχιτεκτονικής ανά μονάδα ισχύος δηλαδή Performance per Watt.[1] Ο λόγος αυτός είναι το μέτρο σύγκρισης συστημάτων με διαφορετική υπολογιστική ισχύ και κατανάλωση. Μπορούμε να θεωρήσουμε για ένα σύστημα τον όρο διεκπεραιωτική ικανότητα ώς τον λόγο των εντολών που εκτελεί προς τον χρόνο. Άρα **Energy_efficiency = (Instructions/seconds)/Watt = Instructions/Power**

*[1] Patterson, D A. & Hennessy, J L. (1998) Computer Organization and Design: The Hardware/Software Interface, Fifth Edition, p.49*

Επομένως γνωρίζοντας μόνο την κατανάλωση των 2 επεξεργαστών δεν μπορούμε να συμπεράνουμε ποιος είναι κατάλληλος για την χρήση του στο σύστημα αυτό αλλά χρειαζόμαστε και τον αριθμό των εντολών που εκτελεί ο επεξεργαστής προς στην ενέργεια που καταναλώνει. Θεωρόντας ένα παράδειγμα, ο δεύτερος επεξεργαστής μπορεί να εκτελεί ένα πρόγραμμα 12 φορές πιο γρήγορα τότε ο πρώτος έχει (12/40)*(5/1)=1,5 φορές καλύτερη ενεργειακή αποδοτικότητα δηλαδή θα λειτουργήσει για λιγότερο χρονο και εν τέλη θα καταναλώσει λιγότερο.

### Energy Efficiency McPat

Τα αποτελέσματα του McPAT περιέχουν στοιχεία για την συχνότητα λειτουργίας, την τεχνολογία των τρανζίστορ της συνολικής αρχιτεκτονικής και επιπλέον την κατανάλωση ισχύος, και την επιφάνεια που καταλαμβάνουν τα επιμέρους στοιχεία του συστήματος. Έτσι μπορούμε να βγάλουμε συμπεράσματα για την ισχύ που απαιτεί η συγκεκριμένη αρχιτεκτονική χωρίς όμως να έχουμε πληροφορίες σχετικά με τον χρόνο προσομοίωσης και τις εντολές που εκτέλεσε στο διάστημα αυτό. Δεν είμαστε έτσι σε θέση να βγάλουμε συμπεράσματα για την ενεργειακή αποδοτικότητα της αρχιτεκτονικής που προσομοιώνει το McPAT.

## Ερώτημα 3ο

Από τα αποτελέσματα του McPAT για τους 2 επεξεργαστές βγάζουμε τα εξής συμπεράσματα

Κατανάλωση Ισχύος Επεξεργαστή | Xeon | Arm A9
------------------------------|------|-------
Total leakage | [36.8319 W](/src/McPAT_output/Xeon.txt#L15) | [0.108687 W](/src/McPAT_output/Arm_A9_2Ghz.txt#L15)
Runtime Dynamic  | [72.9199 W](/src/McPAT_output/Xeon.txt#L20) | [2.96053 W](/src/McPAT_output/Arm_A9_2Ghz.txt#L20)

Μπορούμε να μελετήσουμε την απόδοση αυτή σε 2 κατηγορίες ανάλογα με την κατανάλωση, Dynamic Power και Leakage Power.
Αναφερόμενοι στο **Dynamic Power** ο Xeon απαιτεί περίπου 25 φορές περισσότερη ισχύ Runtime Dynamic Power, δηλαδή καταναλώνει 25 φορές περισσότερο κατά την διάρκεια που εκτελείτε η εφαρμογή, σε σχέση με τον ARM. Αφού ο Xeon έχει 40 φορές μεγαλύτερη υπολογιστική ισχύ, η ενεργειακή αποδοτικότητα του Xeon κατά την εκτέλεση του προγράμματος είναι (40/72.92)*36.83=20 φορές καλύτερη σε σχέση με του Α9.

Όμως το σύστημα δεν τερματίζει μετά το πέρας του προγράμματος έτσι για να βγάλουμε συμπεράσματα για την ενεργειακή αποδοτικότητα χρειάζεται να λάβουμε υπόψιν και το Leakage Power. Αυτή η ισχύς απαιτείται σε όλη την διάρκεια λειτουργία του συστήματος έτσι για τον Xeon είναι περίπου *(36.83 W/0.11 W=)* 360 φορές μεγαλύτερη από τον Arm. Έτσι βλέπομε ότι ο Xeon καταναλώνει πολύ περισσότερο ενέργεια για τον ίδιο χρόνο λειτουργίας σε σχέση με τον Α9.

Επομένoς παρότι ο Xeon έχει καλύτερο Energy Efficiency κατά την εκτέλεση του προγράμματος δεν μπορεί να είναι πιο αποδοτικός από το Α9 για ένα σύστημα που δεν τερματίζει μετά την λήξη της εφαρμογής.

# Βήμα 2ο - Gem5 + McPAT

Δικαιώματα εκτέλεσης το .py

```chmod +x ./my_mcpat/Scripts/GEM5ToMcPAT.py```

Δημιουργία του .xml για την χρήση του στο McPat από τα stats του GEM5ToMcPAT.

*mcpat CPU_Minor template: ./mcpat/ProcessorDescriptionFiles/inorder_arm.xml*

```./Scripts/GEM5toMcPAT.py <gem5 stats file> <gem5 config file (json)> ./mcpat/ProcessorDescriptionFiles/inorder_arm.xml -o Gem5ToMcPat.xml```

Από την δεύτερη εργασία χρησιμοποιούμε τα αποτελέσματα του [Gem5](/src/Gem5_output/Benchmarks_results/) και με την παραπάνω εντολή δημιουργούμε αρχεία xml για την εκτέλεσή του στον McPat. Για λόγους ευκολία και ταχύτητας κατασκευάσαμε το παρακάτω batch script.

[GEM5ToMcPAT.sh](/src/Gem5ToMcPAT/GEM5ToMcPAT.sh)

Το script αυτό παίρνει ως πρώτο όρισμα το φάκελο όπου βρίσκονται τα αποτελέσματα του Gem5. Έχει την δυνατότητα να διαβάσει όλους τους υποφακέλους και να δημιουργήσει σε έναν νέο φάκελο, που προαιρετικά μπαίνει ως δεύτερο όρισμα, τα αντίστοιχα αρχεία xml. Είναι αναγκαίο να βρίσκεται στον φάκελο *my_mcpat* δηλαδή στο repository clone που φτιάξαμε για το McPAT
*Το script μπορεί να δεχτεί και ένα 3ο όρισμα που αφορά το όνομα του φακέλου που θα εκτυπωθούν τα αποτελέσματα από τον προσομοιωτή McPat με είσοδο τα xml που δημιουργήθηκαν προηγούμενος. Εάν δεν δοθεί το όρισμα αυτό δεν εκτελείτε η προσομοίωση.*

 - *Δημιουργούμε όλα τα xml στο φάκελο src/McPAT_output/Benchmarks_results_xml/<benchmark_name>_McPAT/<Benchmark_name>.xml*
 - *Τρέχουμε για όλα τα xml τον McPAT και αποθηκεύουμε τα αποτελέσματα σε φακέλους ./src/McPAT_output/Benchmarks_results_McPAT/<benchmark_name>_McPAT/<Benchmark_name>.txt*
 - *Το script εκτελειτε με την παρακάτω εντολή ενώ όλα τα errors αποθηκεύονται στο ./GEM5ToMcPAT_errors*
 - ```[DIR: ./GEM5ToMcPat.sh ./src/Gem5_output/Benchmarks_results/<Benchmark_name>  ./src/McPAT_output/Benchmarks_results_xml/<Benchmark_name> ./src/McPAT_output/Benchmarks_results_McPAT/<Benchmark_name>]  ```


## Ερώτημα 1ο

Για να βγάλουμε αποτελέσματα για το EDAP ( Energy – Delay – Area ) χρειαζόμαστε τα στατιστικά και των 2 προσωμοιώσεων. Συγκεκριμένα:
-	**Energy** : Θα πάρουμε τα αποτελέσματα από την έξοδο του McPAT και όπως αναφέρει και η εκφώνηση αφορά τα μεγέθη Runtime Dynamic, Subthreshold Leakage και Gate Leakage. Αυτά τα νούμερα αναφέρονται στην μέση ισχύ. Παρόλλα αυτά χρησιμοποιώντας το Delay όπως ορίζεται παρακάτω μπορούμεν α βρούμε και την συνολική μέση ενέργεια που κατανάλωσε το σύστημα για το συγκεκριμένο Benchmark.
-	**Delay**: Την παράμετρο αυτή θα την βρούμε στο stats του Gem5 και εξάγεται από την τιμή **sim_seconds**
-	**Area**: Προφανώς θα την βρούμε στην έξοδο του McPAT στα αντίστοιχα πεδία
- Για την τιμή του **Energy Efficiency** θα λάβουμε υπόψιν τον λόγο 1/sim_seconds*(Runtime Dynamic + Subthreshold Leakage + Gate Leakage) για κάθε προσομοίωση που έγινε με το ίδιο Benchmark. Αυτό το κάνουμε γιατί όλες οι αρχιτεκτονικές εκτέλεσαν τον ίδιο κώδικα. Έτσι μπορούμε να συγκρίνουμε πιο είναι ενεργειακά αποδοτικότερο για τη συγκεκριμένη εφαρμογή.

## Ερώτημα 2ο
